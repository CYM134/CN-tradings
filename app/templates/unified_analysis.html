{% extends "base.html" %}

{% block title %}ç»Ÿä¸€åˆ†æ - è‚¡ç¥¨åˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="p-4 bg-white rounded-4 shadow-sm border-0 d-flex align-items-center justify-content-between">
                <div>
                    <h1 class="h3 fw-bold mb-1 text-dark">ç»Ÿä¸€è‚¡ç¥¨åˆ†æ</h1>
                    <p class="text-muted mb-0 small">é‡åŒ–åˆ†æ + AIæ™ºèƒ½ä½“ç»¼åˆå†³ç­–ç³»ç»Ÿ</p>
                </div>
                <div class="text-primary opacity-25">
                    <i class="fas fa-brain fa-3x"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†æè¾“å…¥åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
            <div class="card card-financial border-0 shadow-sm">
                <div class="card-body p-4">
                    <form id="analysisForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="stockCode" class="form-label small text-muted">è‚¡ç¥¨ä»£ç </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" class="form-control bg-light border-0" id="stockCode" placeholder="ä¾‹å¦‚: 000001.SZ" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="tradeDate" class="form-label small text-muted">åˆ†ææ—¥æœŸ</label>
                                <input type="date" class="form-control bg-light border-0" id="tradeDate">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100 shadow-sm">
                                    <i class="fas fa-bolt me-2"></i>å¼€å§‹æ™ºèƒ½åˆ†æ
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loadingSpinner" style="display: none; min-height: 400px;">
        <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 400px;">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">åˆ†æä¸­...</span>
            </div>
            <p class="mt-4 text-muted fw-bold">æ­£åœ¨è¿›è¡Œç»¼åˆåˆ†æï¼Œè¯·ç¨å€™...</p>
            <p class="text-muted small">é‡åŒ–åˆ†æ + AIæ™ºèƒ½å†³ç­–</p>
        </div>
    </div>

    <!-- åˆ†æç»“æœåŒºåŸŸ -->
    <div id="analysisResults" style="display: none;">
        <!-- ç»Ÿä¸€å†³ç­–ç»“æœ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-financial border-0 shadow-sm border-start border-4 border-danger h-100">
                    <div class="card-body text-center p-4">
                        <h5 class="text-uppercase text-muted fw-bold ls-tight mb-3"><i class="fas fa-trophy me-2 text-warning"></i>æœ€ç»ˆæŠ•èµ„å»ºè®®</h5>
                        <div class="row mt-4 align-items-center">
                            <div class="col-md-4 border-end">
                                <h6 class="text-muted small">ç»¼åˆè¯„çº§</h6>
                                <span id="finalRating" class="badge rounded-pill px-4 py-2 mt-2 fs-5">-</span>
                            </div>
                            <div class="col-md-4 border-end">
                                <h6 class="text-muted small">ç½®ä¿¡åº¦</h6>
                                <div class="progress mt-2" style="height: 10px; background-color: #f1f5f9;">
                                    <div id="finalConfidence" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                                <span id="confidenceText" class="mt-2 d-block small fw-bold text-success">-</span>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-muted small">é£é™©ç­‰çº§</h6>
                                <span id="riskLevel" class="badge bg-secondary rounded-pill px-3 py-2 mt-2">-</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="text-start text-muted small fw-bold mb-2">å†³ç­–ç†ç”±</h6>
                            <p id="finalReasoning" class="text-start mb-0 text-dark">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†åˆ†æç»“æœ -->
        <div class="row g-4">
            <!-- AIæ™ºèƒ½ä½“åˆ†æ -->
            <div class="col-md-6">
                <div class="card card-financial border-0 shadow-sm h-100 border-start border-4 border-primary">
                    <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                        <h5 class="card-title fw-bold text-dark"><i class="fas fa-robot me-2 text-primary"></i>AIæ™ºèƒ½ä½“åˆ†æ</h5>
                    </div>
                    <div class="card-body p-4">
                        <div id="aiAnalysisContent">
                            <div class="row g-3 mb-4">
                                <div class="col-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <small class="text-muted d-block mb-1">æ•´ä½“è¯„çº§</small>
                                        <span id="aiRating" class="fw-bold text-dark">-</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <small class="text-muted d-block mb-1">ç½®ä¿¡åº¦</small>
                                        <span id="aiConfidence" class="fw-bold text-dark">-</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-light rounded-3">
                                        <small class="text-muted d-block mb-1">ç›®æ ‡ä»·æ ¼</small>
                                        <span id="targetPrice" class="fw-bold text-dark">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6 class="text-muted small text-uppercase fw-bold mb-2">æŠ•èµ„å»ºè®®</h6>
                                <p id="investmentAdvice" class="mb-0 text-dark small">-</p>
                            </div>
                            
                            <div>
                                <h6 class="text-muted small text-uppercase fw-bold mb-2">åˆ†ææ‘˜è¦</h6>
                                <div id="analysisSummary" class="d-flex flex-column gap-2">
                                    <div class="d-flex">
                                        <span class="badge bg-light text-dark me-2 border h-auto align-self-start">å¸‚åœº</span>
                                        <small id="marketAnalysis" class="text-secondary">-</small>
                                    </div>
                                    <div class="d-flex">
                                        <span class="badge bg-light text-dark me-2 border h-auto align-self-start">åŸºæœ¬é¢</span>
                                        <small id="fundamentalAnalysis" class="text-secondary">-</small>
                                    </div>
                                    <div class="d-flex">
                                        <span class="badge bg-light text-dark me-2 border h-auto align-self-start">èˆ†æƒ…</span>
                                        <small id="newsAnalysis" class="text-secondary">-</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="aiError" style="display: none;">
                            <div class="alert alert-warning border-0 shadow-sm">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                AIåˆ†ææš‚ä¸å¯ç”¨: <span id="aiErrorMsg">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‡åŒ–åˆ†æ -->
            <div class="col-md-6">
                <div class="card card-financial border-0 shadow-sm h-100 border-start border-4 border-success">
                    <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                        <h5 class="card-title fw-bold text-dark"><i class="fas fa-chart-line me-2 text-success"></i>é‡åŒ–åˆ†æ</h5>
                    </div>
                    <div class="card-body p-4">
                        <div id="quantAnalysisContent">
                            <div class="mb-4">
                                <h6 class="text-muted small text-uppercase fw-bold mb-3">å› å­å¾—åˆ† <small class="text-secondary fw-normal">(æ‚¬åœæŸ¥çœ‹è®¡ç®—ä¾æ®)</small></h6>
                                <ul id="factorScores" class="list-group list-group-flush small">
                                    <li class="list-group-item px-0 border-0 d-flex justify-content-between align-items-center bg-transparent">
                                        <span>ğŸ”¥ åŠ¨é‡å› å­</span>
                                        <span id="momentumScore" class="badge bg-light text-dark border" data-bs-toggle="tooltip">-</span>
                                    </li>
                                    <li class="list-group-item px-0 border-0 d-flex justify-content-between align-items-center bg-transparent">
                                        <span>ğŸ“Š ä»·å€¼å› å­</span>
                                        <span id="valueScore" class="badge bg-light text-dark border" data-bs-toggle="tooltip">-</span>
                                    </li>
                                    <li class="list-group-item px-0 border-0 d-flex justify-content-between align-items-center bg-transparent">
                                        <span>â­ è´¨é‡å› å­</span>
                                        <span id="qualityScore" class="badge bg-light text-dark border" data-bs-toggle="tooltip">-</span>
                                    </li>
                                    <li class="list-group-item px-0 border-0 d-flex justify-content-between align-items-center bg-transparent">
                                        <span>ğŸ“‰ æ³¢åŠ¨ç‡å› å­</span>
                                        <span id="volatilityScore" class="badge bg-light text-dark border" data-bs-toggle="tooltip">-</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="mb-4">
                                <h6 class="text-muted small text-uppercase fw-bold mb-3">MLæ¨¡å‹é¢„æµ‹</h6>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <div class="p-2 border rounded text-center">
                                            <small class="text-muted d-block" style="font-size: 0.7rem;">é¢„æµ‹æ”¶ç›Š</small>
                                            <span id="predictedReturn" class="fw-bold text-success">-</span>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 border rounded text-center">
                                            <small class="text-muted d-block" style="font-size: 0.7rem;">æ¨¡å‹ç½®ä¿¡åº¦</small>
                                            <span id="mlConfidence" class="fw-bold text-primary">-</span>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 border rounded text-center">
                                            <small class="text-muted d-block" style="font-size: 0.7rem;">ä½¿ç”¨æ¨¡å‹</small>
                                            <span id="modelUsed" class="fw-bold text-dark small">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h6 class="text-muted small text-uppercase fw-bold mb-3">æŠ€æœ¯æŒ‡æ ‡</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <span class="badge bg-light text-secondary border fw-normal">RSI: <span id="rsiValue" class="fw-bold text-dark">-</span></span>
                                    <span class="badge bg-light text-secondary border fw-normal">MACD: <span id="macdSignal" class="fw-bold text-dark">-</span></span>
                                    <span class="badge bg-light text-secondary border fw-normal">å¸ƒæ—å¸¦: <span id="bollingerPosition" class="fw-bold text-dark">-</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†ææ—¶é—´æˆ³ -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <p class="text-muted small mb-0">
                    åˆ†ææ—¶é—´: <span id="analysisTimestamp">-</span>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const stockCode = document.getElementById('stockCode').value;
            const tradeDate = document.getElementById('tradeDate').value;
            
            if (!stockCode) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            performUnifiedAnalysis(stockCode, tradeDate);
        });

        function performUnifiedAnalysis(stockCode, tradeDate) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            
            // å‘é€åˆ†æè¯·æ±‚
            fetch('/api/analysis/unified', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    stock_code: stockCode,
                    trade_date: tradeDate
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (data.success) {
                    displayAnalysisResults(data.data);
                } else {
                    alert('åˆ†æå¤±è´¥: ' + (data.message || data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                document.getElementById('loadingSpinner').style.display = 'none';
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            });
        }

        function displayAnalysisResults(data) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('analysisResults').style.display = 'block';
            
            // æœ€ç»ˆå†³ç­–
            const finalDecision = data.final_decision || {};
            const rating = finalDecision.rating || '-';
            document.getElementById('finalRating').textContent = rating;
            const ratingStyle = getRatingStyle(rating);
            document.getElementById('finalRating').className = `badge rounded-pill px-4 py-2 mt-2 fs-5 ${ratingStyle.cls}`;
            document.getElementById('finalRating').style.cssText = ratingStyle.style || '';
            
            const confidence = finalDecision.confidence || 0;
            const confidencePercent = (confidence * 100).toFixed(1);
            const progressBar = document.getElementById('finalConfidence');
            progressBar.style.width = `${confidencePercent}%`;
            progressBar.setAttribute('aria-valuenow', confidencePercent);
            document.getElementById('confidenceText').textContent = `${confidencePercent}%`;
            
            const riskLevel = finalDecision.risk_level || 0;
            const riskInfo = getRiskLevel(riskLevel);
            document.getElementById('riskLevel').textContent = riskInfo.text;
            document.getElementById('riskLevel').className = `badge rounded-pill px-3 py-2 mt-2 ${riskInfo.cls}`;
            
            document.getElementById('finalReasoning').textContent = finalDecision.reasoning || '-';
            
            // AIåˆ†æç»“æœ
            const aiAnalysis = data.ai_analysis || {};
            if (aiAnalysis.ai_available) {
                document.getElementById('aiAnalysisContent').style.display = 'block';
                document.getElementById('aiError').style.display = 'none';
                
                document.getElementById('aiRating').textContent = aiAnalysis.overall_rating || '-';
                document.getElementById('aiConfidence').textContent = `${((aiAnalysis.confidence || 0) * 100).toFixed(1)}%`;
                document.getElementById('targetPrice').textContent = aiAnalysis.target_price || '-';
                document.getElementById('investmentAdvice').textContent = aiAnalysis.investment_advice || '-';
                
                const summary = aiAnalysis.analysis_summary || {};
                document.getElementById('marketAnalysis').textContent = summary.market_analysis || '-';
                document.getElementById('fundamentalAnalysis').textContent = summary.fundamental_analysis || '-';
                document.getElementById('newsAnalysis').textContent = summary.news_analysis || '-';
            } else {
                document.getElementById('aiAnalysisContent').style.display = 'none';
                document.getElementById('aiError').style.display = 'block';
                document.getElementById('aiErrorMsg').textContent = aiAnalysis.error || 'æœåŠ¡ä¸å¯ç”¨';
            }
            
            // é‡åŒ–åˆ†æç»“æœ
            const quantAnalysis = data.quantitative_analysis || {};
            const factorScores = quantAnalysis.factor_scores || {};
            const factorDetails = quantAnalysis.factor_details || {};
            const mlPrediction = quantAnalysis.ml_prediction || {};
            const technicalIndicators = quantAnalysis.technical_indicators || {};
            
            // å› å­å¾—åˆ†ï¼ˆä¿ç•™ä¸¤ä½å°æ•°ï¼‰+ è®¡ç®—ä¾æ®tooltip
            setFactorScore('momentumScore', factorScores.momentum_score, factorDetails.momentum);
            setFactorScore('valueScore', factorScores.value_score, factorDetails.value);
            setFactorScore('qualityScore', factorScores.quality_score, factorDetails.quality);
            setFactorScore('volatilityScore', factorScores.volatility_score, factorDetails.volatility);
            
            document.getElementById('predictedReturn').textContent = `${((mlPrediction.predicted_return || 0) * 100).toFixed(2)}%`;
            document.getElementById('mlConfidence').textContent = `${((mlPrediction.confidence || 0) * 100).toFixed(1)}%`;
            document.getElementById('modelUsed').textContent = mlPrediction.model_used || '-';
            
            document.getElementById('rsiValue').textContent = technicalIndicators.rsi || '-';
            document.getElementById('macdSignal').textContent = technicalIndicators.macd_signal || '-';
            document.getElementById('bollingerPosition').textContent = technicalIndicators.bollinger_position || '-';
            
            // åˆ†ææ—¶é—´æˆ³
            document.getElementById('analysisTimestamp').textContent = data.analysis_timestamp || '-';
        }

        function setFactorScore(elementId, score, detail) {
            const el = document.getElementById(elementId);
            const val = (score || 0).toFixed(2);
            el.textContent = val;
            // æ ¹æ®å¾—åˆ†è®¾ç½®é¢œè‰²
            const numVal = parseFloat(val);
            if (numVal >= 70) {
                el.className = 'badge bg-success-subtle text-success border border-success';
            } else if (numVal >= 50) {
                el.className = 'badge bg-warning-subtle text-warning border border-warning';
            } else {
                el.className = 'badge bg-danger-subtle text-danger border border-danger';
            }
            // æ·»åŠ tooltipæ˜¾ç¤ºè®¡ç®—ä¾æ®
            if (detail) {
                el.title = detail;
                el.style.cursor = 'help';
            }
        }

        function getRatingStyle(rating) {
            // ä¸­æ–‡è¯„çº§æ ·å¼æ˜ å°„ï¼šä¹°å…¥ç»¿è‰²ï¼Œå–å‡ºçº¢è‰²ï¼ŒæŒä»“é»„è‰²
            if (rating.includes('ä¹°å…¥')) {
                return { cls: '', style: 'background-color: #198754; color: white;' };  // ç»¿è‰²
            } else if (rating.includes('å–å‡º')) {
                return { cls: '', style: 'background-color: #dc3545; color: white;' };  // çº¢è‰²
            } else if (rating.includes('æŒä»“')) {
                return { cls: '', style: 'background-color: #ffc107; color: #333;' };   // é»„è‰²
            }
            // å…¼å®¹è‹±æ–‡è¯„çº§
            switch(rating) {
                case 'STRONG_BUY': 
                case 'BUY': return { cls: '', style: 'background-color: #198754; color: white;' };
                case 'HOLD': return { cls: '', style: 'background-color: #ffc107; color: #333;' };
                case 'SELL': 
                case 'STRONG_SELL': return { cls: '', style: 'background-color: #dc3545; color: white;' };
                default: return { cls: 'bg-secondary', style: '' };
            }
        }

        function getRiskLevel(riskScore) {
            if (riskScore < 0.3) return { text: 'ä½é£é™©', cls: 'bg-success' };
            if (riskScore < 0.7) return { text: 'ä¸­ç­‰é£é™©', cls: 'bg-warning text-dark' };
            return { text: 'é«˜é£é™©', cls: 'bg-danger' };
        }
    </script>
{% endblock %}
